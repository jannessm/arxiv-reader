<html>
    <head>
        <title>Arxiv Reader</title>
    </head>
    <body>
        <div id="input">
            <input id="filter" oninput="filter()" placeholder="Filter">
            <textarea oninput="parse(event.target.value)" placeholder="Subscription Content"></textarea>
            <div id="buttons">
                <button onclick="clearInput()">Clear Input</button>
                <button onclick="paste()">Paste Subscription Content</button>
            </div>
        </div>
        <div id="preview">
            <div id="prev" onclick="prev()"><p><</p></div>
            <a href="">
                <div id="content">
                    <div id="title"></div>
                    <div id="authors"></div>
                    <div id="abstract"></div>
                </div>
            </a>
            <div id="next" onclick="next()"><p>></p></div>
        </div>
        <div id="index"></div>

        <style>
            body {
                margin: 24px 25%;
                width: 50%;
                box-sizing: border-box;
                font-family: sans-serif;
            }
            button {
                width: 100%;
                margin: 12px 0;
                padding: 12px;
                border: none;
            }
            input, textarea {
                width: 100%;
                border: lightgrey 1px solid;
                padding: 12px;
            }
            #buttons {
                display: flex;
                gap: 8px;
            }

            a {
                text-decoration: none;
                color: darkslategrey;
                background: buttonface;
            }

            #preview {
                display: flex;
                justify-content: space-evenly;
                align-items: stretch;
            }
            #content {
                padding: 24px;
                width: 85%;
            }
            #title {
                font-size: 2em;
            }
            #prev, #next {
                cursor: pointer;
                padding: 24px;
                display: flex;
                align-items: center;
            }
            #prev:hover, #next:hover {
                cursor: pointer;
                background: lightgray;
            }
            #index {
                text-align: center;
                padding: 24px;
            }
        </style>

        <script>
            class Entry {
                constructor(title, authors, abstract, link) {
                    this.title = title;
                    this.authors = authors;
                    this.abstract = abstract;
                    this.link = link;
                }

                matches(search_str) {
                    search_str = search_str.toLowerCase();
                    return [this.title, this.authors, this.abstract, this.link].reduce((matches, val) => matches || val.toLowerCase().includes(search_str), false);
                }
            }

            function restoreObjects(name) {
                return JSON.parse(window.localStorage.getItem(name) || "[]")
                           .map(val => new Entry(val.title, val.authors, val.abstract, val.link));
            }

            document.addEventListener('keyup', (e) => {
                const filter_has_focus = document.activeElement !== document.querySelector('#filter');
                if (e.code === "ArrowRight" && filter_has_focus)        next();
                else if (e.code === "ArrowLeft" && filter_has_focus)    prev();
            });

            function parse(mail) {
                entries = [];

                const matches = [...mail.matchAll(re)];

                matches.forEach(m => entries.push(new Entry(m[1], m[2], m[3], m[4])));
                window.localStorage.setItem('entries', JSON.stringify(entries));

                curr_entry_id = 0;
                filter();
                update_entry();
            }

            function update_entry() {
                if (filtered_entries.length == 0) {
                    document.querySelector('#preview').style.display = 'none';
                    document.querySelector('#index').innerText = 0 + " / " + 0;   
                } else {
                    document.querySelector('#preview').style.display = '';
                    document.querySelector('#title').innerText = filtered_entries[curr_entry_id].title;
                    document.querySelector('a').setAttribute('href', filtered_entries[curr_entry_id].link);
                    document.querySelector('#authors').innerText = filtered_entries[curr_entry_id].authors;
                    document.querySelector('#abstract').innerText = filtered_entries[curr_entry_id].abstract;
                    document.querySelector('#index').innerText = curr_entry_id + 1 + " / " + filtered_entries.length;
                }
                window.localStorage.setItem('entry_id', curr_entry_id);
            }

            function prev() {
                curr_entry_id = Math.max(0, curr_entry_id - 1);
                update_entry();
            }
            function next() {
                curr_entry_id = Math.min(filtered_entries.length - 1, curr_entry_id + 1);
                update_entry();
            }
            
            function filter() {
                if (input_delay) {
                    clearTimeout(input_delay);
                }
                input_delay = setTimeout(() => {
                    const filter = document.querySelector('#filter').value.split(',').map(v => v.trim());
                    filtered_entries = entries.filter(val => filter.reduce((matches, search_str) => matches || val.matches(search_str), false));
                    
                    window.localStorage.setItem('filter', document.querySelector('#filter').value);
                    window.localStorage.setItem('filtered_entries', JSON.stringify(filtered_entries));
                    
                    update_entry();
                }, 500);
            }

            function paste() {
                if (navigator.userAgent.includes("Firefox")){
                    alert('Paste is not working in Firefox. Please paste your text in the textarea above.');
                    return;
                }
                navigator.clipboard.readText().then((clipText) => parse(clipText));
            }

            function clearInput() {
                document.querySelector('textarea').value = '';
                entries = [];
                filtered_entries = [];
                curr_entry_id = 0;
                window.localStorage.setItem('entries', JSON.stringify(entries));
                window.localStorage.setItem('filtered_entries', JSON.stringify(filtered_entries));
                window.localStorage.setItem('entry_id', 0);
                update_entry();
            }


            // init
            let entries = restoreObjects('entries');
            let filtered_entries = restoreObjects('filtered_entries');
            let curr_entry_id = parseInt(window.localStorage.getItem('entry_id')) || 0;
            let input_delay;

            const re = /Title: ([^\n]*)\nAuthors: ([^\n]*)\n[^\\]*\\\\([^\\]*)\\\\ \( ([^\s]+)/gm;

            document.querySelector('#filter').value = window.localStorage.getItem('filter') || '';
            update_entry();
        </script>
    </body>
</html>
